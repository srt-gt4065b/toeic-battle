<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸš€ í† ìµ ì˜ë‹¨ì–´ ê°¤ëŸ¬ê·¸ - ë°°í‹€ëª¨ë“œ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1a2e 50%, #0a0a15 100%);
            color: white;
        }

        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
        }

        .card {
            background: rgba(26, 26, 46, 0.95);
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 100px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .logo { font-size: 50px; text-align: center; margin-bottom: 10px; }
        .title {
            font-size: clamp(22px, 5vw, 28px);
            text-align: center;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-battle {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }
        .btn:hover { transform: translateY(-2px); opacity: 0.95; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 13px;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 16px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ëª¨ë“œ ì„ íƒ ë²„íŠ¼ */
        .mode-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .mode-btn {
            flex: 1;
            padding: 20px 10px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .mode-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .mode-btn.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }
        .mode-btn.battle.selected {
            border-color: #f093fb;
            background: rgba(240, 147, 251, 0.2);
        }
        .mode-icon { font-size: 30px; margin-bottom: 8px; }
        .mode-label { font-size: 14px; font-weight: bold; }
        .mode-desc { font-size: 11px; color: #888; margin-top: 5px; }

        /* ë°© ì½”ë“œ ì…ë ¥ */
        .room-code-input {
            font-size: 24px !important;
            text-align: center;
            letter-spacing: 8px;
            text-transform: uppercase;
        }
        .room-code-display {
            font-size: 36px;
            text-align: center;
            letter-spacing: 10px;
            color: #ffd700;
            background: rgba(255,215,0,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }

        /* ëŒ€ê¸°ì‹¤ */
        .waiting-players {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .player-slot {
            flex: 1;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
        }
        .player-slot.filled {
            border-style: solid;
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }
        .player-slot.me {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .player-avatar { font-size: 40px; margin-bottom: 10px; }
        .player-name { font-size: 14px; font-weight: bold; }
        .player-status { font-size: 12px; color: #888; margin-top: 5px; }
        .player-status.ready { color: #4caf50; }

        /* ë°°í‹€ ê²Œì„ í™”ë©´ */
        .game-screen {
            padding: 0;
            justify-content: flex-start;
            align-items: center !important;
        }

        .battle-header {
            flex-shrink: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            padding: 4px !important;
            height: 80px !important;
            background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
            gap: 10px;
        }

        .player-score-box {
            flex: 1;
            padding: 8px 12px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
        }
        .player-score-box.pulse {
            transform: scale(1.05);
            filter: brightness(1.3);
        }
        .player-score-box.left {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(102, 126, 234, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.5);
        }
        .player-score-box.right {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.3), rgba(240, 147, 251, 0.1));
            border: 1px solid rgba(240, 147, 251, 0.5);
        }
        .player-score-box .name {
            font-size: 11px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-score-box .score {
            font-size: 22px;
            font-weight: bold;
        }
        .player-score-box.left .score { color: #667eea; }
        .player-score-box.right .score { color: #f093fb; }
        .player-score-box .streak {
            font-size: 10px;
            color: #ffd700;
        }

        .vs-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #ff6b6b;
        }

        .battle-status {
            flex-shrink: 0;
            width: 100%;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
        }
        .battle-status .question-num {
            color: #ffd700;
        }

        .question-box {
            flex-shrink: 0;
            width: 100%;
            padding: 12px;
            text-align: center;
            background: rgba(0,0,0,0.5);
        }
        .word-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .word-korean {
            font-size: clamp(20px, 5vw, 28px);
            font-weight: bold;
            color: #ffd700;
        }

        .game-canvas-container {
            flex: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            min-height: 55vh;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        #gameCanvas {
            display: block !important;
            margin: 0 auto !important;
            max-width: 100%;
        }

        .mobile-controls {
            flex-shrink: 0;
            width: 100%;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.8);
        }
        .control-left { display: flex; gap: 15px; }
        .ctrl-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        .fire-btn {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-color: #ff6b6b;
            font-size: 14px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .mobile-controls { display: flex; }
        }

        /* ë°°í‹€ ê²°ê³¼ í™”ë©´ */
        .battle-result {
            text-align: center;
        }
        .winner-announcement {
            font-size: 50px;
            margin-bottom: 10px;
        }
        .winner-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .winner-title.win { color: #ffd700; }
        .winner-title.lose { color: #888; }
        .winner-title.draw { color: #4caf50; }

        .battle-scores {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .battle-score-card {
            flex: 1;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }
        .battle-score-card.winner {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05));
            border: 2px solid #ffd700;
        }
        .battle-score-card.loser {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
        }
        .score-card-name { font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .score-card-value { font-size: 32px; font-weight: bold; }
        .score-card-detail { font-size: 12px; color: #888; margin-top: 5px; }

        /* ë¡œë”© */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-overlay.active { display: flex; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .feedback-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            z-index: 500;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: pre-line;
        }
        .feedback-popup.show { opacity: 1; }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .level-btn {
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .level-btn:hover { background: rgba(255,255,255,0.1); }
        .level-btn.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }
        .level-score { font-size: 20px; font-weight: bold; }
        .level-label { font-size: 11px; color: #888; }

        .admin-link {
            text-align: center;
            margin-top: 15px;
        }
        .admin-link a {
            color: #666;
            font-size: 12px;
            text-decoration: none;
        }

        .hearts-display {
            display: flex;
            gap: 3px;
            justify-content: center;
        }
        .heart { font-size: 16px; }
        .heart.lost { opacity: 0.3; }

        /* ë³µì‚¬ ë²„íŠ¼ */
        .copy-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }
        .copy-btn:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="feedback-popup" id="feedbackPopup"></div>

    <!-- ===== ë¡œê·¸ì¸ í™”ë©´ ===== -->
    <div class="screen active" id="loginScreen">
        <div class="card">
            <div style="text-align:center; margin-bottom:15px;">
                <div style="font-size:12px; color:#667eea; letter-spacing:1px;">ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</div>
                <div style="font-size:14px; color:#f093fb; font-weight:bold; margin-top:3px;">ğŸ“ ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</div>
            </div>
            <div class="logo">ğŸš€</div>
            <h1 class="title">í† ìµ ì˜ë‹¨ì–´ ê°¤ëŸ¬ê·¸</h1>
            <p class="subtitle">TOEIC Vocabulary Battle</p>

            <div class="input-group">
                <label>í•™ë²ˆ (Student ID)</label>
                <input type="text" id="studentId" placeholder="í•™ë²ˆ ì…ë ¥ / Enter Student ID" maxlength="20">
            </div>

            <div class="input-group">
                <label>ì´ë¦„ (Name)</label>
                <input type="text" id="playerName" placeholder="ì´ë¦„ ì…ë ¥ / Enter Name" maxlength="10">
            </div>

            <!-- ê²Œì„ ëª¨ë“œ ì„ íƒ -->
            <div style="margin: 20px 0;">
                <label style="display:block; margin-bottom:10px; color:#aaa; font-size:13px;">ê²Œì„ ëª¨ë“œ ì„ íƒ (Select Mode)</label>
                <div class="mode-buttons">
                    <div class="mode-btn selected" onclick="selectMode('solo')" id="modeSolo">
                        <div class="mode-icon">ğŸ‘¤</div>
                        <div class="mode-label">1ì¸ ê²Œì„</div>
                        <div class="mode-desc">Solo Mode</div>
                    </div>
                    <div class="mode-btn battle" onclick="selectMode('battle')" id="modeBattle">
                        <div class="mode-icon">âš”ï¸</div>
                        <div class="mode-label">2ì¸ ë°°í‹€</div>
                        <div class="mode-desc">Battle Mode</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="login()" id="loginBtn">ğŸ® ì‹œì‘í•˜ê¸° (Start)</button>
            <button class="btn btn-secondary" onclick="showScreen('leaderboardScreen')">ğŸ† ìˆœìœ„ ë³´ê¸° (Ranking)</button>

            <div class="admin-link">
                <a href="admin.html">ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ (Admin)</a>
            </div>
        </div>
    </div>

    <!-- ===== ë°°í‹€ ë¡œë¹„ í™”ë©´ ===== -->
    <div class="screen" id="battleLobbyScreen">
        <div class="card">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <h2 class="title">âš”ï¸ 2ì¸ ë°°í‹€ ëª¨ë“œ</h2>
            <p class="subtitle">ì¹œêµ¬ì™€ í•¨ê»˜ ì˜ë‹¨ì–´ ëŒ€ê²°!</p>

            <button class="btn btn-battle" onclick="createRoom()">ğŸ  ë°© ë§Œë“¤ê¸° (Create Room)</button>
            
            <div style="text-align:center; margin:15px 0; color:#666;">â€” ë˜ëŠ” â€”</div>

            <div class="input-group">
                <label>ë°© ì½”ë“œ ì…ë ¥ (Room Code)</label>
                <input type="text" id="roomCodeInput" class="room-code-input" placeholder="ABCD" maxlength="4">
            </div>
            <button class="btn btn-success" onclick="joinRoom()">ğŸšª ë°© ì°¸ê°€í•˜ê¸° (Join Room)</button>

            <button class="btn btn-secondary" onclick="showScreen('loginScreen')" style="margin-top:20px;">â† ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <!-- ===== ëŒ€ê¸°ì‹¤ í™”ë©´ ===== -->
    <div class="screen" id="waitingRoomScreen">
        <div class="card">
            <h2 class="title">ğŸ® ëŒ€ê¸°ì‹¤</h2>
            <p class="subtitle">ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>

            <div class="room-code-display" id="displayRoomCode">ABCD</div>
            <button class="copy-btn" onclick="copyRoomCode()">ğŸ“‹ ì½”ë“œ ë³µì‚¬í•˜ê¸°</button>

            <div class="waiting-players">
                <div class="player-slot me filled" id="player1Slot">
                    <div class="player-avatar">ğŸ‘¤</div>
                    <div class="player-name" id="player1Name">ë‚˜</div>
                    <div class="player-status" id="player1Status">ëŒ€ê¸° ì¤‘</div>
                </div>
                <div class="player-slot" id="player2Slot">
                    <div class="player-avatar">â“</div>
                    <div class="player-name" id="player2Name">ìƒëŒ€ë°©</div>
                    <div class="player-status" id="player2Status">ì ‘ì† ëŒ€ê¸° ì¤‘...</div>
                </div>
            </div>

            <!-- ë ˆë²¨ ì„ íƒ (ë°©ì¥ë§Œ) -->
            <div id="levelSelectArea" style="display:none;">
                <label style="display:block; margin-bottom:10px; color:#aaa; font-size:13px;">ë ˆë²¨ ì„ íƒ (ë°©ì¥)</label>
                <div class="level-grid" id="battleLevelGrid">
                    <div class="level-btn selected" onclick="selectBattleLevel(300)">
                        <div class="level-score">300</div>
                        <div class="level-label">ê¸°ì´ˆ</div>
                    </div>
                    <div class="level-btn" onclick="selectBattleLevel(400)">
                        <div class="level-score">400</div>
                        <div class="level-label">ì´ˆê¸‰</div>
                    </div>
                    <div class="level-btn" onclick="selectBattleLevel(500)">
                        <div class="level-score">500</div>
                        <div class="level-label">ì¤‘ê¸‰</div>
                    </div>
                    <div class="level-btn" onclick="selectBattleLevel(600)">
                        <div class="level-score">600</div>
                        <div class="level-label">ì¤‘ê³ ê¸‰</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-battle" onclick="startBattle()" id="startBattleBtn" disabled>
                â³ ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...
            </button>
            <button class="btn btn-secondary" onclick="leaveRoom()">ğŸšª ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <!-- ===== 1ì¸ ë ˆë²¨ ì„ íƒ í™”ë©´ ===== -->
    <div class="screen" id="levelScreen">
        <div class="card">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <h2 class="title">ğŸ“š ë ˆë²¨ ì„ íƒ</h2>
            <p class="subtitle">ëª©í‘œ í† ìµ ì ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>

            <div class="level-grid">
                <div class="level-btn" onclick="selectLevel(300)">
                    <div class="level-score">300</div>
                    <div class="level-label">ê¸°ì´ˆ</div>
                </div>
                <div class="level-btn" onclick="selectLevel(400)">
                    <div class="level-score">400</div>
                    <div class="level-label">ì´ˆê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(500)">
                    <div class="level-score">500</div>
                    <div class="level-label">ì¤‘ê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(600)">
                    <div class="level-score">600</div>
                    <div class="level-label">ì¤‘ê³ ê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(700)">
                    <div class="level-score">700</div>
                    <div class="level-label">ê³ ê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(800)">
                    <div class="level-score">800</div>
                    <div class="level-label">ì‹¤ì „</div>
                </div>
                <div class="level-btn" onclick="selectLevel(900)">
                    <div class="level-score">900</div>
                    <div class="level-label">ë§ˆìŠ¤í„°</div>
                </div>
                <div class="level-btn" onclick="selectLevel(1000)">
                    <div class="level-score">990+</div>
                    <div class="level-label">ì±”í”¼ì–¸</div>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="showScreen('loginScreen')">â† ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <!-- ===== ê²Œì„ í™”ë©´ ===== -->
    <div class="screen game-screen" id="gameScreen">
        <!-- ë°°í‹€ëª¨ë“œ: ì–‘ìª½ ì ìˆ˜ í‘œì‹œ -->
        <div class="battle-header" id="battleHeader" style="display:none;">
            <div class="player-score-box left" id="battleLeftBox">
                <div class="name" id="battleLeftName">ë‚˜</div>
                <div class="score" id="battleLeftScore">0</div>
                <div class="streak" id="battleLeftStreak"></div>
            </div>
            <div class="vs-badge">VS</div>
            <div class="player-score-box right" id="battleRightBox">
                <div class="name" id="battleRightName">ìƒëŒ€</div>
                <div class="score" id="battleRightScore">0</div>
                <div class="streak" id="battleRightStreak"></div>
            </div>
        </div>

        <!-- ì†”ë¡œëª¨ë“œ: ê¸°ì¡´ í—¤ë” -->
        <div id="soloHeader" style="flex-shrink:0; width:100%; padding:8px; background:linear-gradient(180deg, rgba(0,0,0,0.8), transparent);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:center; flex:1;">
                    <div style="font-size:11px; color:#888;">ë ˆë²¨ ì ìˆ˜</div>
                    <div style="font-size:20px; font-weight:bold; color:#667eea;" id="scoreDisplay">0</div>
                </div>
                <div style="text-align:center; flex:1;">
                    <div style="font-size:11px; color:#888;">ë¬¸ì œ</div>
                    <div style="font-size:16px; font-weight:bold;" id="questionDisplay">1/?</div>
                </div>
                <div style="text-align:center; flex:1;">
                    <div style="font-size:11px; color:#888;">ë‚¨ì€ ê¸°íšŒ</div>
                    <div class="hearts-display" id="heartsDisplay">
                        <span class="heart">â¤ï¸</span>
                        <span class="heart">â¤ï¸</span>
                        <span class="heart">â¤ï¸</span>
                        <span class="heart">â¤ï¸</span>
                        <span class="heart">â¤ï¸</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="battle-status" id="battleStatus" style="display:none;">
            <span class="question-num" id="battleQuestionNum">ë¬¸ì œ 1/10</span>
        </div>

        <div class="question-box">
            <div class="word-label">ì´ ëœ»ì„ ê°€ì§„ ì˜ë‹¨ì–´ëŠ”?</div>
            <div class="word-korean" id="koreanWord">-</div>
        </div>

        <div class="game-canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="mobile-controls">
            <div class="control-left">
                <button class="ctrl-btn" id="leftBtn">â—€</button>
                <button class="ctrl-btn" id="rightBtn">â–¶</button>
            </div>
            <button class="ctrl-btn fire-btn" id="fireBtn">ğŸ’¥ ë°œì‚¬</button>
        </div>
    </div>

    <!-- ===== ì†”ë¡œ ê²°ê³¼ í™”ë©´ ===== -->
    <div class="screen" id="resultScreen">
        <div class="card">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <div style="text-align:center;">
                <div style="font-size:50px;" id="resultIcon">ğŸ‰</div>
                <h2 id="resultTitle" style="margin:10px 0;">ë¯¸ì…˜ ì„±ê³µ!</h2>
            </div>
            <div style="display:flex; justify-content:space-around; margin:20px 0;">
                <div style="text-align:center;">
                    <div style="font-size:24px; font-weight:bold; color:#667eea;" id="resultScore">0</div>
                    <div style="font-size:12px; color:#888;">ì ìˆ˜</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:24px; font-weight:bold; color:#4caf50;" id="resultCorrect">0</div>
                    <div style="font-size:12px; color:#888;">ì •ë‹µ</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:24px; font-weight:bold; color:#f44336;" id="resultWrong">0</div>
                    <div style="font-size:12px; color:#888;">ì˜¤ë‹µ</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="restartLevel()">ğŸ”„ ë‹¤ì‹œ ë„ì „</button>
            <button class="btn btn-secondary" onclick="showScreen('levelScreen')">ğŸ“š ë ˆë²¨ ì„ íƒ</button>
        </div>
    </div>

    <!-- ===== ë°°í‹€ ê²°ê³¼ í™”ë©´ ===== -->
    <div class="screen" id="battleResultScreen">
        <div class="card battle-result">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <div class="winner-announcement" id="battleResultIcon">ğŸ†</div>
            <div class="winner-title win" id="battleResultTitle">ìŠ¹ë¦¬!</div>

            <div class="battle-scores">
                <div class="battle-score-card winner" id="leftScoreCard">
                    <div class="score-card-name" id="leftCardName">ë‚˜</div>
                    <div class="score-card-value" id="leftCardScore">0</div>
                    <div class="score-card-detail" id="leftCardDetail">ì •ë‹µ 0 / ì˜¤ë‹µ 0</div>
                </div>
                <div class="battle-score-card loser" id="rightScoreCard">
                    <div class="score-card-name" id="rightCardName">ìƒëŒ€</div>
                    <div class="score-card-value" id="rightCardScore">0</div>
                    <div class="score-card-detail" id="rightCardDetail">ì •ë‹µ 0 / ì˜¤ë‹µ 0</div>
                </div>
            </div>

            <button class="btn btn-battle" onclick="rematch()">ğŸ”„ ì¬ëŒ€ê²° (Rematch)</button>
            <button class="btn btn-secondary" onclick="exitBattle()">ğŸšª ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <!-- ===== ìˆœìœ„í‘œ í™”ë©´ ===== -->
    <div class="screen" id="leaderboardScreen">
        <div class="card">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <h2 class="title">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            <p class="subtitle">ìµœê³  ì ìˆ˜ ê¸°ì¤€</p>
            <div id="leaderboardList" style="max-height:300px; overflow-y:auto;">
                <!-- ë™ì  ë¡œë“œ -->
            </div>
            <button class="btn btn-secondary" onclick="showScreen('loginScreen')" style="margin-top:15px;">â† ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // ========================================
        // Firebase ì„¤ì •
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAvU3l3c6qLOqtorOe_zlcs2oCj6PfF62o",
            authDomain: "toeic-battle.firebaseapp.com",
            databaseURL: "https://toeic-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "toeic-battle",
            storageBucket: "toeic-battle.firebasestorage.app",
            messagingSenderId: "949933180792",
            appId: "1:949933180792:web:13772f58226882453d6a8d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ê³ ì • ê°€ìƒ ìº”ë²„ìŠ¤ í¬ê¸°
        const LOGICAL_WIDTH = 420;
        const LOGICAL_HEIGHT = 720;

        // ========================================
        // ê²Œì„ ìƒíƒœ
        // ========================================
        let gameMode = 'solo';  // 'solo' ë˜ëŠ” 'battle'
        let isHost = false;     // ë°©ì¥ ì—¬ë¶€
        let roomCode = '';      // í˜„ì¬ ë°© ì½”ë“œ
        let roomRef = null;     // Firebase ë°© ë ˆí¼ëŸ°ìŠ¤
        let roomListener = null; // ë°© ìƒíƒœ ë¦¬ìŠ¤ë„ˆ

        let player = {
            studentId: '',
            name: '',
            currentLevel: 300,
            totalScore: 0,
            passedLevels: []
        };

        let opponent = {
            studentId: '',
            name: '',
            score: 0,
            correct: 0,
            wrong: 0,
            streak: 0
            // ìœ„ì¹˜ ë° ì´ì•Œ ë™ê¸°í™” ì‚­ì œ (ì•ˆì •ì„± ìœ„í•´ ì ìˆ˜ë§Œ ë™ê¸°í™”)
        };

        let game = {
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,
            running: false,
            words: [],
            usedWordIndices: [],
            currentWord: null,
            questionNumber: 0,
            totalQuestions: 0,
            score: 0,
            correctCount: 0,
            wrongCount: 0,
            maxWrong: 5,
            wrongWords: [],
            questionAnswered: false,
            streak: 0,
            ship: { x: 0, y: 0, width: 40, height: 40, speed: 8 },
            bullets: [],
            enemies: [],
            particles: [],
            confetti: [],
            keys: {},
            touchX: null,
            lastTime: 0,
            animFrame: null,
            scaleFactor: 1,
            deviceScale: 1,
            questionOrder: []  // ë°°í‹€ëª¨ë“œìš© ë¬¸ì œ ìˆœì„œ
        };

        // ê¸°ë³¸ ë‹¨ì–´
        const defaultWords = {
            300: [
                { word: "apple", meaning: "ì‚¬ê³¼" },
                { word: "book", meaning: "ì±…" },
                { word: "car", meaning: "ìë™ì°¨" },
                { word: "dog", meaning: "ê°œ" },
                { word: "eat", meaning: "ë¨¹ë‹¤" },
                { word: "food", meaning: "ìŒì‹" },
                { word: "good", meaning: "ì¢‹ì€" },
                { word: "happy", meaning: "í–‰ë³µí•œ" },
                { word: "ice", meaning: "ì–¼ìŒ" },
                { word: "job", meaning: "ì§ì—…" },
                { word: "water", meaning: "ë¬¼" },
                { word: "house", meaning: "ì§‘" },
                { word: "school", meaning: "í•™êµ" },
                { word: "friend", meaning: "ì¹œêµ¬" },
                { word: "love", meaning: "ì‚¬ë‘" }
            ],
            400: [{ word: "achieve", meaning: "ë‹¬ì„±í•˜ë‹¤" }, { word: "benefit", meaning: "ì´ìµ" }, { word: "consider", meaning: "ê³ ë ¤í•˜ë‹¤" }, { word: "develop", meaning: "ê°œë°œí•˜ë‹¤" }],
            500: [{ word: "accommodate", meaning: "ìˆ˜ìš©í•˜ë‹¤" }, { word: "acknowledge", meaning: "ì¸ì •í•˜ë‹¤" }, { word: "adequate", meaning: "ì ì ˆí•œ" }, { word: "anticipate", meaning: "ì˜ˆìƒí•˜ë‹¤" }],
            600: [{ word: "acquisition", meaning: "íšë“, ì¸ìˆ˜" }, { word: "allocate", meaning: "í• ë‹¹í•˜ë‹¤" }, { word: "amendment", meaning: "ìˆ˜ì •, ê°œì •" }, { word: "authorize", meaning: "ìŠ¹ì¸í•˜ë‹¤" }]
        };

        // ========================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ========================================
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function showFeedback(message, color) {
            const popup = document.getElementById('feedbackPopup');
            popup.textContent = message;
            popup.style.background = color;
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 2000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'leaderboardScreen') {
                loadLeaderboard();
            }
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        function playSound(freq, duration, type) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = freq;
                oscillator.type = type;
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (e) {}
        }

        // ========================================
        // ëª¨ë“œ ì„ íƒ ë° ë¡œê·¸ì¸
        // ========================================
        function selectMode(mode) {
            gameMode = mode;
            document.getElementById('modeSolo').classList.toggle('selected', mode === 'solo');
            document.getElementById('modeBattle').classList.toggle('selected', mode === 'battle');
            
            const btn = document.getElementById('loginBtn');
            if (mode === 'solo') {
                btn.textContent = 'ğŸ® ì‹œì‘í•˜ê¸° (Start)';
                btn.className = 'btn btn-primary';
            } else {
                btn.textContent = 'âš”ï¸ ë°°í‹€ ì‹œì‘ (Battle)';
                btn.className = 'btn btn-battle';
            }
        }

        function login() {
            const studentId = document.getElementById('studentId').value.trim();
            const name = document.getElementById('playerName').value.trim();
            
            if (!studentId || !name) {
                showFeedback('í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', '#f44336');
                return;
            }
            
            player.studentId = studentId;
            player.name = name;
            player.totalScore = 0;
            player.passedLevels = [];
            
            if (gameMode === 'solo') {
                showScreen('levelScreen');
            } else {
                showScreen('battleLobbyScreen');
            }
        }

        // ========================================
        // ë°°í‹€ ëª¨ë“œ ë¡œì§
        // ========================================
        async function createRoom() {
            showLoading(true);
            isHost = true;
            roomCode = generateRoomCode();
            
            try {
                roomRef = database.ref(`toeic_galaga/battle_rooms/${roomCode}`);
                
                await roomRef.set({
                    status: 'waiting',
                    level: 300,
                    questionIndex: 0,
                    questionOrder: [],
                    host: {
                        name: player.name,
                        studentId: player.studentId,
                        score: 0,
                        correct: 0,
                        wrong: 0,
                        streak: 0,
                        answered: false
                    },
                    guest: null,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                showLoading(false);
                showWaitingRoom();
                listenToRoom();
                
            } catch (error) {
                showLoading(false);
                showFeedback('ë°© ìƒì„± ì‹¤íŒ¨', '#f44336');
            }
        }

        async function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (code.length !== 4) {
                showFeedback('4ìë¦¬ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', '#f44336');
                return;
            }
            
            showLoading(true);
            isHost = false;
            roomCode = code;
            
            try {
                roomRef = database.ref(`toeic_galaga/battle_rooms/${roomCode}`);
                const snapshot = await roomRef.once('value');
                
                if (!snapshot.exists()) {
                    showLoading(false);
                    showFeedback('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤', '#f44336');
                    return;
                }
                
                const roomData = snapshot.val();
                if (roomData.guest) {
                    showLoading(false);
                    showFeedback('ì´ë¯¸ ê°€ë“ ì°¬ ë°©ì…ë‹ˆë‹¤', '#f44336');
                    return;
                }
                
                await roomRef.child('guest').set({
                    name: player.name,
                    studentId: player.studentId,
                    score: 0,
                    correct: 0,
                    wrong: 0,
                    streak: 0,
                    answered: false
                });
                
                opponent.name = roomData.host.name;
                opponent.studentId = roomData.host.studentId;
                
                showLoading(false);
                showWaitingRoom();
                listenToRoom();
                
            } catch (error) {
                showLoading(false);
                showFeedback('ë°© ì°¸ê°€ ì‹¤íŒ¨', '#f44336');
            }
        }

        function showWaitingRoom() {
            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('player1Name').textContent = player.name + (isHost ? ' (ë°©ì¥)' : '');
            document.getElementById('player1Slot').classList.add('filled', 'me');
            
            if (isHost) {
                document.getElementById('levelSelectArea').style.display = 'block';
            } else {
                document.getElementById('levelSelectArea').style.display = 'none';
            }
            
            showScreen('waitingRoomScreen');
        }

        // ========================================
        // ë°© ìƒíƒœ ë¦¬ìŠ¤ë‹ (ì ìˆ˜/ìƒíƒœ ë™ê¸°í™”)
        // ========================================
        function listenToRoom() {
            if (roomListener) {
                roomRef.off('value', roomListener);
            }
            
            roomListener = roomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    showFeedback('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', '#f44336');
                    showScreen('battleLobbyScreen');
                    return;
                }
                
                const data = snapshot.val();
                
                // ìƒëŒ€ë°© ì •ë³´ ì—…ë°ì´íŠ¸
                if (isHost && data.guest) {
                    opponent.name = data.guest.name;
                    opponent.studentId = data.guest.studentId;
                    updateWaitingUI(data);
                } else if (!isHost && data.host) {
                    opponent.name = data.host.name;
                    opponent.studentId = data.host.studentId;
                    updateWaitingUI(data);
                }
                
                // ë ˆë²¨ ë™ê¸°í™”
                if (!isHost && data.level) {
                    player.currentLevel = data.level;
                }
                
                // ê²Œì„ ì‹œì‘
                if (data.status === 'playing' && !game.running) {
                    game.questionOrder = data.questionOrder || [];
                    startBattleGame();
                }
                
                // ì ìˆ˜ ì‹¤ì‹œê°„ ë™ê¸°í™”
                if (data.status === 'playing' && game.running) {
                    const opponentData = isHost ? data.guest : data.host;
                    if (opponentData) {
                        const oldScore = opponent.score;
                        opponent.score = opponentData.score || 0;
                        opponent.correct = opponentData.correct || 0;
                        opponent.wrong = opponentData.wrong || 0;
                        opponent.streak = opponentData.streak || 0;
                        
                        updateBattleScores();
                        
                        // ì ìˆ˜ê°€ ì˜¬ëìœ¼ë©´ íš¨ê³¼ ì£¼ê¸°
                        if (opponent.score > oldScore) {
                            const oppBox = document.getElementById('battleRightBox');
                            oppBox.classList.remove('pulse');
                            void oppBox.offsetWidth; // ë¦¬í”Œë¡œìš°
                            oppBox.classList.add('pulse');
                        }
                    }
                }
                
                // ê²Œì„ ì¢…ë£Œ
                if (data.status === 'finished') {
                    showBattleResult(data);
                }
            });
        }

        function updateWaitingUI(data) {
            const hasGuest = !!data.guest;
            document.getElementById('player2Slot').classList.toggle('filled', hasGuest);
            document.getElementById('player2Name').textContent = hasGuest ? opponent.name : 'ìƒëŒ€ë°©';
            document.getElementById('player2Status').textContent = hasGuest ? 'ì¤€ë¹„ ì™„ë£Œ!' : 'ì ‘ì† ëŒ€ê¸° ì¤‘...';
            document.getElementById('player2Status').classList.toggle('ready', hasGuest);
            document.getElementById('player2Slot').querySelector('.player-avatar').textContent = hasGuest ? 'ğŸ‘¤' : 'â“';
            
            const startBtn = document.getElementById('startBattleBtn');
            if (isHost && hasGuest) {
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸš€ ê²Œì„ ì‹œì‘!';
            } else if (isHost) {
                startBtn.disabled = true;
                startBtn.textContent = 'â³ ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...';
            } else {
                startBtn.disabled = true;
                startBtn.textContent = 'â³ ë°©ì¥ì´ ì‹œì‘í•©ë‹ˆë‹¤...';
            }
        }

        function selectBattleLevel(level) {
            player.currentLevel = level;
            document.querySelectorAll('#battleLevelGrid .level-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.level-btn').classList.add('selected');
            
            if (isHost && roomRef) {
                roomRef.child('level').set(level);
            }
        }

        async function startBattle() {
            if (!isHost) return;
            showLoading(true);
            
            try {
                const snapshot = await database.ref(`toeic_galaga/words/level${player.currentLevel}`).once('value');
                if (snapshot.exists()) {
                    game.words = [];
                    snapshot.forEach(child => { game.words.push(child.val()); });
                } else {
                    game.words = [...(defaultWords[player.currentLevel] || defaultWords[300])];
                }
                
                const numQuestions = Math.min(10, game.words.length);
                const indices = Array.from({length: game.words.length}, (_, i) => i);
                const shuffled = shuffleArray(indices).slice(0, numQuestions);
                
                await roomRef.update({
                    status: 'playing',
                    questionIndex: 0,
                    questionOrder: shuffled,
                    level: player.currentLevel
                });
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showFeedback('ê²Œì„ ì‹œì‘ ì‹¤íŒ¨', '#f44336');
            }
        }

        async function startBattleGame() {
            showLoading(true);
            try {
                const snapshot = await database.ref(`toeic_galaga/words/level${player.currentLevel}`).once('value');
                if (snapshot.exists()) {
                    game.words = [];
                    snapshot.forEach(child => { game.words.push(child.val()); });
                } else {
                    game.words = [...(defaultWords[player.currentLevel] || defaultWords[300])];
                }
                
                showLoading(false);
                document.getElementById('battleHeader').style.display = 'flex';
                document.getElementById('soloHeader').style.display = 'none';
                document.getElementById('battleStatus').style.display = 'block';
                
                document.getElementById('battleLeftName').textContent = player.name;
                document.getElementById('battleRightName').textContent = opponent.name;
                
                showScreen('gameScreen');
                setTimeout(() => {
                    initBattleGame();
                    requestAnimationFrame(gameLoop);
                }, 100);
            } catch (error) {
                showLoading(false);
                showFeedback('ê²Œì„ ë¡œë“œ ì‹¤íŒ¨', '#f44336');
            }
        }

        function initBattleGame() {
            game.canvas = document.getElementById('gameCanvas');
            game.ctx = game.canvas.getContext('2d');
            resizeCanvas();
            
            game.running = true;
            game.score = 0;
            game.correctCount = 0;
            game.wrongCount = 0;
            game.questionNumber = 0;
            game.totalQuestions = game.questionOrder.length;
            game.usedWordIndices = [];
            game.wrongWords = [];
            game.bullets = [];
            game.enemies = [];
            game.particles = [];
            game.confetti = [];
            game.streak = 0;
            game.questionAnswered = false;
            
            game.ship.x = game.width / 2 - game.ship.width / 2;
            game.ship.y = game.height - game.ship.height - 20;
            
            updateBattleScores();
            nextBattleQuestion();
            setupControls();
        }

        function nextBattleQuestion() {
            if (game.questionNumber >= game.totalQuestions) {
                endBattle();
                return;
            }
            
            const wordIndex = game.questionOrder[game.questionNumber];
            game.currentWord = game.words[wordIndex];
            game.questionNumber++;
            game.questionAnswered = false;
            game.enemies = [];
            game.bullets = [];
            
            document.getElementById('koreanWord').textContent = game.currentWord.meaning;
            document.getElementById('battleQuestionNum').textContent = `ë¬¸ì œ ${game.questionNumber}/${game.totalQuestions}`;
            
            const myPath = isHost ? 'host' : 'guest';
            roomRef.child(myPath).update({ answered: false });
            
            spawnEnemies();
        }

        function updateBattleScores() {
            document.getElementById('battleLeftScore').textContent = game.score;
            document.getElementById('battleRightScore').textContent = opponent.score;
            
            if (game.streak >= 3) document.getElementById('battleLeftStreak').textContent = `ğŸ”¥ ${game.streak}ì—°ì†!`;
            else document.getElementById('battleLeftStreak').textContent = '';
            
            if (opponent.streak >= 3) document.getElementById('battleRightStreak').textContent = `ğŸ”¥ ${opponent.streak}ì—°ì†!`;
            else document.getElementById('battleRightStreak').textContent = '';
        }

        async function endBattle() {
            game.running = false;
            if (game.animFrame) cancelAnimationFrame(game.animFrame);

            const myPath = isHost ? 'host' : 'guest';
            await roomRef.child(myPath).update({
                score: game.score,
                correct: game.correctCount,
                wrong: game.wrongCount,
                streak: game.streak
            });
            
            if (isHost) {
                setTimeout(async () => {
                    await roomRef.child('status').set('finished');
                }, 500);
            }
        }

        function showBattleResult(data) {
            game.running = false;
            if (game.animFrame) cancelAnimationFrame(game.animFrame);
            
            const myData = isHost ? data.host : data.guest;
            const oppData = isHost ? data.guest : data.host;
            const myScore = myData?.score || 0;
            const oppScore = oppData?.score || 0;
            
            let resultIcon, resultTitle, titleClass;
            if (myScore > oppScore) {
                resultIcon = 'ğŸ†'; resultTitle = 'ìŠ¹ë¦¬! (Victory!)'; titleClass = 'win';
                playSound(523, 0.3, 'sine'); setTimeout(() => playSound(784, 0.3, 'sine'), 200);
            } else if (myScore < oppScore) {
                resultIcon = 'ğŸ˜¢'; resultTitle = 'íŒ¨ë°°... (Defeat)'; titleClass = 'lose';
                playSound(200, 0.3, 'sawtooth');
            } else {
                resultIcon = 'ğŸ¤'; resultTitle = 'ë¬´ìŠ¹ë¶€! (Draw!)'; titleClass = 'draw';
                playSound(440, 0.3, 'sine');
            }
            
            document.getElementById('battleResultIcon').textContent = resultIcon;
            document.getElementById('battleResultTitle').textContent = resultTitle;
            document.getElementById('battleResultTitle').className = 'winner-title ' + titleClass;
            
            document.getElementById('leftCardName').textContent = player.name;
            document.getElementById('leftCardScore').textContent = myScore;
            document.getElementById('leftCardDetail').textContent = `ì •ë‹µ ${myData?.correct || 0} / ì˜¤ë‹µ ${myData?.wrong || 0}`;
            document.getElementById('leftScoreCard').className = 'battle-score-card ' + (myScore >= oppScore ? 'winner' : 'loser');
            
            document.getElementById('rightCardName').textContent = opponent.name;
            document.getElementById('rightCardScore').textContent = oppScore;
            document.getElementById('rightCardDetail').textContent = `ì •ë‹µ ${oppData?.correct || 0} / ì˜¤ë‹µ ${oppData?.wrong || 0}`;
            document.getElementById('rightScoreCard').className = 'battle-score-card ' + (oppScore >= myScore ? 'winner' : 'loser');
            
            showScreen('battleResultScreen');
        }

        // ========================================
        // ê²Œì„ ì—”ì§„ (ê³µí†µ)
        // ========================================
        function resizeCanvas() {
            if (!game.canvas) return;
            const canvas = game.canvas;
            const container = canvas.parentElement || document.body;
            const rect = container.getBoundingClientRect();
            
            let deviceWidth = rect.width || window.innerWidth;
            let deviceHeight = rect.height || (window.innerHeight - 200);

            canvas.width = LOGICAL_WIDTH;
            canvas.height = LOGICAL_HEIGHT;
            game.width = LOGICAL_WIDTH;
            game.height = LOGICAL_HEIGHT;

            const scale = Math.min(deviceWidth / LOGICAL_WIDTH, deviceHeight / LOGICAL_HEIGHT);
            canvas.style.width = (LOGICAL_WIDTH * scale) + 'px';
            canvas.style.height = (LOGICAL_HEIGHT * scale) + 'px';
            game.deviceScale = scale;
        }

        function spawnEnemies() {
            const correctWord = game.currentWord.word;
            const otherWords = game.words.filter(w => w.word !== correctWord).map(w => w.word);
            const wrongWords = shuffleArray([...otherWords]).slice(0, 3);
            const allOptions = shuffleArray([{ text: correctWord, isCorrect: true }, ...wrongWords.map(w => ({ text: w, isCorrect: false }))]);
            
            const padding = 10;
            const gap = 8;
            const availableWidth = game.width - (padding * 2);
            const isMobile = (window.innerWidth < 600);
            let blockWidth, blockHeight, cols;
            
            if (isMobile) { cols = 2; blockWidth = Math.min(120, (availableWidth - gap) / 2); blockHeight = 50; }
            else { cols = 4; blockWidth = Math.min(130, (availableWidth - gap * 3) / 4); blockHeight = 55; }
            
            const totalGridWidth = (blockWidth * cols) + (gap * (cols - 1));
            const startX = (game.width - totalGridWidth) / 2;
            
            allOptions.forEach((option, i) => {
                let col, row;
                if (isMobile) { col = i % 2; row = Math.floor(i / 2); }
                else { col = i; row = 0; }
                
                game.enemies.push({
                    x: startX + col * (blockWidth + gap),
                    y: -60 - row * (blockHeight + gap + 10) - (isMobile ? 0 : i * 20),
                    width: blockWidth, height: blockHeight,
                    speed: 0.7 + Math.random() * 0.3,
                    text: option.text, isCorrect: option.isCorrect,
                    type: 'main', color: '#3949ab', glowColor: '#7986cb',
                    destroyed: false, wobbleOffset: Math.random() * Math.PI * 2,
                    baseX: startX + col * (blockWidth + gap),
                    maxWobble: Math.min(15, (game.width - totalGridWidth) / 4)
                });
            });
        }

        function shoot() {
            if (!game.running || game.bullets.length >= 3) return;
            game.bullets.push({ x: game.ship.x + game.ship.width / 2, y: game.ship.y - 10, radius: 12, speed: 10 });
            playSound(150, 0.3, 'triangle');
        }

        function checkCollision(bullet, enemy) {
            const circleX = bullet.x; const circleY = bullet.y;
            const closestX = Math.max(enemy.x, Math.min(circleX, enemy.x + enemy.width));
            const closestY = Math.max(enemy.y, Math.min(circleY, enemy.y + enemy.height));
            const distanceX = circleX - closestX; const distanceY = circleY - closestY;
            return (distanceX * distanceX + distanceY * distanceY) < (bullet.radius * bullet.radius);
        }

        function handleCorrectAnswer(enemy) {
            createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#00ff88');
            game.score += 100;
            game.correctCount++;
            game.streak++;
            game.questionAnswered = true;
            playSound(523, 0.3, 'sine');
            
            // ì ìˆ˜ê°€ ì˜¤ë¥´ë©´ ë‚´ ì ìˆ˜íŒ ê°•ì¡°
            if (gameMode === 'battle') {
                const leftBox = document.getElementById('battleLeftBox');
                leftBox.classList.remove('pulse');
                void leftBox.offsetWidth;
                leftBox.classList.add('pulse');

                if (roomRef) {
                    const myPath = isHost ? 'host' : 'guest';
                    roomRef.child(myPath).update({
                        score: game.score,
                        correct: game.correctCount,
                        streak: game.streak,
                        answered: true
                    });
                }
            }
            
            if (game.streak > 0 && game.streak % 5 === 0) {
                createConfetti();
                const bonus = (Math.floor((player.currentLevel - 300) / 100) + 1) * 1000;
                game.score += bonus;
                showFeedback(`ğŸŠ ${game.streak}ì—°ì† ì •ë‹µ! +${bonus}ì `, '#ff6b9d');
                playSound(988, 0.3, 'sine');
                
                if (gameMode === 'battle' && roomRef) {
                    const myPath = isHost ? 'host' : 'guest';
                    roomRef.child(myPath + '/score').set(game.score);
                }
            } else {
                showFeedback('ğŸ‰ ì •ë‹µ! +100ì ', '#4caf50');
            }
            
            if (gameMode === 'battle') {
                updateBattleScores();
                setTimeout(() => nextBattleQuestion(), 1000);
            } else {
                document.getElementById('scoreDisplay').textContent = game.score;
                setTimeout(() => nextSoloQuestion(), 1000);
            }
        }

        function handleWrongAnswer(enemy) {
            createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#ff4444');
            game.wrongCount++;
            game.streak = 0;
            game.questionAnswered = true;
            game.wrongWords.push(game.currentWord);
            playSound(200, 0.2, 'sawtooth');
            
            if (gameMode === 'battle') {
                if (roomRef) {
                    const myPath = isHost ? 'host' : 'guest';
                    roomRef.child(myPath).update({ wrong: game.wrongCount, streak: 0, answered: true });
                }
                updateBattleScores();
                showFeedback(`âŒ ì˜¤ë‹µ!\nì •ë‹µ: ${game.currentWord.word}`, '#f44336');
                setTimeout(() => nextBattleQuestion(), 1500);
            } else {
                updateHeartsDisplay();
                if (game.wrongCount >= game.maxWrong) {
                    showFeedback('ğŸ’” ê¸°íšŒë¥¼ ëª¨ë‘ ìƒì—ˆì–´ìš”!', '#f44336');
                    setTimeout(() => gameOver(), 1500);
                } else {
                    showFeedback(`âŒ ì˜¤ë‹µ!\nì •ë‹µ: ${game.currentWord.word}`, '#f44336');
                    setTimeout(() => nextSoloQuestion(), 1500);
                }
            }
        }

        // ========================================
        // ë Œë”ë§ ë° ë£¨í”„
        // ========================================
        function gameLoop(timestamp) {
            if (!game.running) return;
            const dt = timestamp - game.lastTime;
            game.lastTime = timestamp;
            
            update(dt);
            render();
            game.animFrame = requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            // ìš°ì£¼ì„  ì´ë™
            if (game.keys['ArrowLeft']) game.ship.x -= game.ship.speed;
            if (game.keys['ArrowRight']) game.ship.x += game.ship.speed;
            if (game.touchX !== null) game.ship.x += (game.touchX - game.ship.width/2 - game.ship.x) * 0.15;
            game.ship.x = Math.max(0, Math.min(game.width - game.ship.width, game.ship.x));
            
            // ì´ì•Œ
            game.bullets = game.bullets.filter(b => { b.y -= b.speed; return b.y > -b.radius; });
            
            // ì  ì´ë™ ë° ì¶©ëŒ
            let mainCount = 0, allGone = true;
            game.enemies.forEach(enemy => {
                if (enemy.destroyed) return;
                if (enemy.type === 'main') { mainCount++; if (enemy.y < game.height) allGone = false; }
                
                enemy.y += enemy.speed;
                enemy.x = (enemy.baseX || enemy.x) + Math.sin(Date.now()/500 + enemy.wobbleOffset) * (enemy.maxWobble || 10);
                
                game.bullets.forEach((bullet, bi) => {
                    if (checkCollision(bullet, enemy)) {
                        game.bullets.splice(bi, 1);
                        enemy.destroyed = true;
                        if (enemy.isCorrect) handleCorrectAnswer(enemy);
                        else if (enemy.type === 'main') handleWrongAnswer(enemy);
                    }
                });
            });
            
            if (mainCount > 0 && allGone && !game.questionAnswered) handleWrongAnswer(game.enemies[0]); // íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬

            // íŒŒí‹°í´
            game.particles = game.particles.filter(p => { p.x+=p.vx; p.y+=p.vy; p.vy+=0.15; p.life--; return p.life>0; });
            game.confetti = game.confetti.filter(c => { c.x+=c.vx; c.y+=c.vy; c.vy+=0.1; c.rotation+=c.rotationSpeed; c.life--; return c.life>0; });
        }

        function render() {
            const ctx = game.ctx;
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, game.width, game.height);
            
            // ë³„ ë°°ê²½
            const time = Date.now() / 1000;
            for (let i=0; i<50; i++) {
                ctx.fillStyle = `rgba(255,255,255,${0.3 + Math.sin(time*2+i)*0.2})`;
                ctx.fillRect((i*137.5)%game.width, ((i*73.3+time*20)%game.height), 2, 2);
            }
            
            // ì  ê·¸ë¦¬ê¸°
            game.enemies.forEach(enemy => {
                if (enemy.destroyed) return;
                ctx.save();
                ctx.shadowColor = enemy.glowColor; ctx.shadowBlur = 15;
                const grad = ctx.createLinearGradient(enemy.x, enemy.y, enemy.x, enemy.y+enemy.height);
                grad.addColorStop(0, '#5c6bc0'); grad.addColorStop(1, '#3949ab');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.roundRect(enemy.x, enemy.y, enemy.width, enemy.height, 8); ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.stroke();
                ctx.fillStyle = 'white'; ctx.font = `bold ${Math.max(14, Math.floor(18 * game.scaleFactor))}px Arial`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(enemy.text, enemy.x+enemy.width/2, enemy.y+enemy.height/2);
                ctx.restore();
            });
            
            // ì´ì•Œ ê·¸ë¦¬ê¸°
            game.bullets.forEach(b => {
                ctx.save(); ctx.shadowColor='#ff6600'; ctx.shadowBlur=20;
                const grad = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.radius);
                grad.addColorStop(0,'#fff'); grad.addColorStop(0.6,'#ff6600');
                ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
                ctx.restore();
            });
            
            // ë‚´ ìš°ì£¼ì„  ê·¸ë¦¬ê¸°
            drawShip();
            
            // íš¨ê³¼ ê·¸ë¦¬ê¸°
            game.particles.forEach(p => { ctx.fillStyle=p.color; ctx.globalAlpha=p.life/50; ctx.fillRect(p.x-3,p.y-3,6,6); });
            game.confetti.forEach(c => {
                ctx.save(); ctx.globalAlpha=Math.min(1, c.life/30); ctx.fillStyle=c.color;
                ctx.translate(c.x,c.y); ctx.rotate(c.rotation*Math.PI/180);
                ctx.fillRect(-c.size/2, -c.size/4, c.size, c.size/2);
                ctx.restore();
            });
            ctx.globalAlpha=1;
        }

        function drawShip() {
            const ctx = game.ctx, x = game.ship.x, y = game.ship.y, w = game.ship.width, h = game.ship.height;
            ctx.save(); ctx.shadowColor='#00ffff'; ctx.shadowBlur=15;
            ctx.fillStyle='#4fc3f7';
            ctx.beginPath(); ctx.moveTo(x+w/2,y); ctx.lineTo(x+w,y+h); ctx.lineTo(x+w/2,y+h*0.7); ctx.lineTo(x,y+h); ctx.fill();
            ctx.restore();
            ctx.fillStyle = `hsl(${30+Math.random()*30},100%,60%)`;
            ctx.beginPath(); ctx.moveTo(x+w*0.3,y+h); ctx.lineTo(x+w/2,y+h+10+Math.random()*8); ctx.lineTo(x+w*0.7,y+h); ctx.fill();
        }

        // ì´í™íŠ¸ ìƒì„±
        function createExplosion(x, y, color) {
            for(let i=0; i<20; i++) game.particles.push({x, y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, color, life:30+Math.random()*20});
        }
        function createConfetti() {
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3'];
            [0.2, 0.5, 0.8].forEach(pos => {
                for(let i=0; i<20; i++) game.confetti.push({
                    x: game.width*pos, y: game.height, vx:(Math.random()-0.5)*8, vy:-10-Math.random()*5,
                    color: colors[Math.floor(Math.random()*4)], size: 5+Math.random()*8, rotation:0, rotationSpeed:(Math.random()-0.5)*15, life:80+Math.random()*40
                });
            });
        }

        // ê¸°íƒ€ ê¸°ëŠ¥ (ì…”í”Œ, ì»¨íŠ¸ë¡¤ ë“±)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function setupControls() {
            document.addEventListener('keydown', e => { game.keys[e.code] = true; if(e.code==='Space'){e.preventDefault(); shoot();} });
            document.addEventListener('keyup', e => game.keys[e.code] = false);
            game.canvas.addEventListener('touchstart', e => { e.preventDefault(); const r=game.canvas.getBoundingClientRect(); game.touchX=(e.touches[0].clientX-r.left)*(game.width/r.width); }, {passive:false});
            game.canvas.addEventListener('touchmove', e => { e.preventDefault(); const r=game.canvas.getBoundingClientRect(); game.touchX=(e.touches[0].clientX-r.left)*(game.width/r.width); }, {passive:false});
            game.canvas.addEventListener('touchend', () => { game.touchX=null; shoot(); });
            document.getElementById('leftBtn').ontouchstart = (e) => { e.preventDefault(); game.keys['ArrowLeft'] = true; };
            document.getElementById('leftBtn').ontouchend = () => game.keys['ArrowLeft'] = false;
            document.getElementById('rightBtn').ontouchstart = (e) => { e.preventDefault(); game.keys['ArrowRight'] = true; };
            document.getElementById('rightBtn').ontouchend = () => game.keys['ArrowRight'] = false;
            document.getElementById('fireBtn').ontouchstart = (e) => { e.preventDefault(); shoot(); };
        }

        // ì†”ë¡œ ëª¨ë“œ ê´€ë ¨ í•¨ìˆ˜ (ì¶•ì•½ë¨)
        function selectLevel(level) { player.currentLevel = level; startSoloGame(); }
        async function startSoloGame() {
            showLoading(true);
            game.words = [...(defaultWords[player.currentLevel] || defaultWords[300])];
            showLoading(false);
            document.getElementById('battleHeader').style.display='none';
            document.getElementById('soloHeader').style.display='block';
            document.getElementById('battleStatus').style.display='none';
            showScreen('gameScreen');
            setTimeout(() => { initSoloGame(); requestAnimationFrame(gameLoop); }, 100);
        }
        function initSoloGame() {
            game.canvas=document.getElementById('gameCanvas'); game.ctx=game.canvas.getContext('2d'); resizeCanvas();
            game.running=true; game.score=0; game.correctCount=0; game.wrongCount=0; game.questionNumber=0; game.totalQuestions=game.words.length;
            game.usedWordIndices=[]; game.bullets=[]; game.enemies=[];
            game.ship.x=game.width/2-game.ship.width/2; game.ship.y=game.height-game.ship.height-20;
            updateHeartsDisplay(); nextSoloQuestion(); setupControls();
        }
        function nextSoloQuestion() {
            if(game.usedWordIndices.length>=game.words.length) { missionSuccess(); return; }
            const available = game.words.map((_,i)=>i).filter(i=>!game.usedWordIndices.includes(i));
            const idx = available[Math.floor(Math.random()*available.length)];
            game.usedWordIndices.push(idx); game.currentWord=game.words[idx];
            game.questionNumber++; game.questionAnswered=false; game.enemies=[]; game.bullets=[];
            document.getElementById('koreanWord').textContent=game.currentWord.meaning;
            document.getElementById('questionDisplay').textContent=`${game.questionNumber}/${game.totalQuestions}`;
            spawnEnemies();
        }
        function updateHeartsDisplay() {
            let html=''; for(let i=0;i<game.maxWrong;i++) html+= i<(game.maxWrong-game.wrongCount)?'<span class="heart">â¤ï¸</span>':'<span class="heart lost">ğŸ–¤</span>';
            document.getElementById('heartsDisplay').innerHTML=html;
        }
        function missionSuccess() { game.running=false; showScreen('resultScreen'); playSound(523,0.3,'sine'); }
        function gameOver() { game.running=false; showScreen('resultScreen'); }
        function restartLevel() { gameMode==='battle'?showWaitingRoom():startSoloGame(); }
        function rematch() { if(isHost) roomRef.update({status:'waiting',questionIndex:0,questionOrder:[],'host/score':0,'host/streak':0,'guest/score':0,'guest/streak':0}); showWaitingRoom(); }
        function exitBattle() { leaveRoom(); showScreen('loginScreen'); }
        function leaveRoom() { if(roomListener) roomRef.off('value',roomListener); if(isHost && roomRef) roomRef.remove(); else if(roomRef) roomRef.child('guest').remove(); roomRef=null; isHost=false; }
        function copyRoomCode() { navigator.clipboard.writeText(roomCode).then(()=>showFeedback('ë³µì‚¬ ì™„ë£Œ!', '#4caf50')); }
        
        window.addEventListener('resize', () => { if(game.canvas) resizeCanvas(); });
        window.addEventListener('beforeunload', leaveRoom);
    </script>
</body>
</html>
